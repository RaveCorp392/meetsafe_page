<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MeetSafe Messaging Console (Sender)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .log-area::-webkit-scrollbar {
      width: 8px;
    }
    .log-area::-webkit-scrollbar-thumb {
      background: #a0aec0;
      border-radius: 10px;
    }
    .button-primary {
      @apply bg-blue-500 text-white px-4 py-2 rounded shadow hover:bg-blue-600 transition-colors;
    }
    .button-secondary {
      @apply bg-gray-300 text-gray-800 px-4 py-2 rounded shadow hover:bg-gray-400 transition-colors;
    }
    .input-field {
      @apply block w-full my-2 p-2 border rounded focus:ring-blue-500 focus:border-blue-500;
    }
    .contact-actions {
      @apply ml-4 space-x-2;
    }
    .edit-btn {
      @apply bg-yellow-500 text-white px-2 py-1 rounded text-sm hover:bg-yellow-600;
    }
    .delete-btn {
      @apply bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600;
    }
  </style>
</head>
<body class="p-6 space-y-8">
  <h1 class="text-3xl font-bold">MeetSafe Messaging Console (Sender)</h1>

  <!-- Dynamic content would be added here -->

  <script type="module">
    import { getFirestore, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-lite.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

    const firebaseConfig = {
      // Your config here
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function sendAppMessageWithFallback(contact, message, rendezvousId) {
      let messageAcknowledged = false;
      const fallbackTimeout = setTimeout(() => {
        if (!messageAcknowledged) {
          sendTwilioSms(contact.phoneNumber, message, rendezvousId);
          logToMonitor("Fallback SMS triggered", "warning", "monitorLogSender");
        }
      }, 15000);

      try {
        const ackDoc = {
          to: contact.id,
          content: message,
          rendezvousId: rendezvousId,
          sentAt: Timestamp.now()
        };

        await addDoc(collection(db, `artifacts/${rendezvousId}/acks`), ackDoc);
        logToMonitor("App message sent via FCM", "success", "monitorLogSender");
      } catch (error) {
        logToMonitor(`Error sending app message: ${error.message}`, "error", "monitorLogSender");
      }
    }

    async function sendTwilioSms(phone, content, rendezvousId) {
      try {
        const result = await fetch("/send-sms", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ to: phone, message: content, rendezvousId })
        });

        const response = await result.json();
        if (response.sid) {
          logToMonitor(`SMS sent. SID: ${response.sid}`, "success", "twilioSmsLog");
        } else {
          throw new Error("SID missing in response");
        }
      } catch (error) {
        logToMonitor(`SMS error: ${error.message}`, "error", "twilioSmsLog");
      }
    }

    async function sendMessage(recipientContact, messageContent, testRendezvousId) {
      try {
        const messagesCollectionRef = collection(db, `artifacts/${testRendezvousId}/messages`);
        await addDoc(messagesCollectionRef, {
          to: recipientContact.id,
          from: "currentUserId",
          sentAt: Timestamp.now(),
          delivered: false,
          method: recipientContact.method,
          fallback: "none",
          acknowledged: false,
          content: messageContent,
          recipientEmail: recipientContact.email || null,
          recipientPhone: recipientContact.phoneNumber || null
        });

        logToMonitor(`Sender: Message initiated to ${recipientContact.name}`, "info", "monitorLogSender");

        if (recipientContact.method === "app") {
          sendAppMessageWithFallback(recipientContact, messageContent, testRendezvousId);
        } else if (recipientContact.method === "sms") {
          await addDoc(messagesCollectionRef, { delivered: true });
          logToMonitor(`Sender: Direct SMS initiated to ${recipientContact.name}`, "info", "monitorLogSender");

          if (recipientContact.phoneNumber) {
            sendTwilioSms(recipientContact.phoneNumber, messageContent, testRendezvousId);
          } else {
            logToMonitor(`Sender: Cannot send Direct SMS to ${recipientContact.name} - no phone number`, "warning", "monitorLogSender");
          }
        }
      } catch (error) {
        logToMonitor(`Sender: Error sending message: ${error.message}`, "error", "monitorLogSender");
      }
    }

    function logToMonitor(message, level, targetId) {
      const logTarget = document.getElementById(targetId);
      const timestamp = new Date().toLocaleTimeString();
      const color = {
        info: "text-blue-600",
        success: "text-green-600",
        warning: "text-yellow-600",
        error: "text-red-600"
      }[level] || "text-gray-800";
      if (logTarget) {
        logTarget.innerHTML += `<p class="\${color}">[\${timestamp}] \${message}</p>`;
      }
    }
  </script>
</body>
</html>
