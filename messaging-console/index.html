<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MeetSafe Messaging Console (Sender)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .log-area::-webkit-scrollbar {
      width: 8px;
    }
    .log-area::-webkit-scrollbar-thumb {
      background: #a0aec0;
      border-radius: 10px;
    }
    .button-primary {
      @apply bg-blue-500 text-white px-4 py-2 rounded shadow hover:bg-blue-600 transition-colors;
    }
    .input-field {
      @apply block w-full my-2 p-2 border rounded focus:ring-blue-500 focus:border-blue-500;
    }
  </style>
</head>
<body class="p-6 space-y-8">
  <h1 class="text-3xl font-bold">MeetSafe Messaging Console (Sender)</h1>
  <div class="text-red-600 font-semibold">🔥 Full feature set loaded: Auth, Contacts, In-App + Fallback SMS</div>

  <div id="console"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, updateDoc, deleteDoc, addDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAV52Ads-ckhKuGsKvHoYYTrDIqBHMHusQ",
      authDomain: "meetsafe-clean-core.firebaseapp.com",
      projectId: "meetsafe-clean-core",
      storageBucket: "meetsafe-clean-core.appspot.com",
      messagingSenderId: "970833854934",
      appId: "1:970833854934:web:5ae847503baa2c6c552477"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const uid = () => auth.currentUser?.uid;
    const el = id => document.getElementById(id);

    const state = {
      contacts: [],
      selectedContact: null,
    };

    function log(msg, elId = "monitorLogSender") {
      const elLog = document.getElementById(elId);
      if (!elLog) return;
      const ts = new Date().toLocaleTimeString();
      elLog.innerHTML += `<div class='text-green-400'>[${ts}] ${msg}</div>`;
      elLog.scrollTop = elLog.scrollHeight;
    }

    function buildUI() {
      el("console").innerHTML = `
        <div class="bg-white p-4 rounded shadow">
          <h2 class="text-xl font-semibold mb-3">Authentication</h2>
          <input id="authEmailSender" type="email" class="input-field" placeholder="Email" value="sender@example.com"/>
          <input id="authPasswordSender" type="password" class="input-field" placeholder="Password" value="password123"/>
          <div class="flex space-x-2 mt-2">
            <button id="signUpBtnSender" class="button-primary bg-blue-500">Sign Up</button>
            <button id="signInBtnSender" class="button-primary bg-green-500">Sign In</button>
            <button id="signOutBtnSender" class="button-primary bg-red-500">Sign Out</button>
          </div>
          <p class="mt-4 text-sm">Current User: <span id="currentUserDisplaySender" class="font-medium">Not authenticated</span><br>User ID: <span id="currentUidDisplaySender" class="font-medium">N/A</span></p>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <h2 class="text-xl font-semibold mb-3">Trusted Contacts</h2>
          <input id="contactName" class="input-field" placeholder="Contact Name"/>
          <input id="contactEmail" type="email" class="input-field" placeholder="Contact Email (for app)"/>
          <input id="contactPhone" type="tel" class="input-field" placeholder="Contact Phone (for SMS fallback)"/>
          <div class="flex space-x-2 mt-2">
            <button id="addContactBtn" class="button-primary bg-purple-500">Add Contact</button>
          </div>
          <ul id="contactsList" class="list-disc pl-5 text-sm mt-4"></ul>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <h2 class="text-xl font-semibold mb-3">Send Message</h2>
          <select id="recipientContact" class="input-field">
            <option value="">Select a Contact</option>
          </select>
          <input id="messageContent" class="input-field" placeholder="Message content" />
          <input id="testRendezvousIdSender" class="input-field" placeholder="Rendezvous ID (e.g. test-rdv-123)" value="test-rdv-123"/>
          <div class="mt-2">
            <label class="inline-flex items-center mr-4">
              <input type="radio" name="deliverySim" value="success" checked class="form-radio h-4 w-4 text-green-600">
              <span class="ml-2 text-gray-700">Simulate In-App Success</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="deliverySim" value="failure" class="form-radio h-4 w-4 text-red-600">
              <span class="ml-2 text-gray-700">Simulate In-App Failure</span>
            </label>
          </div>
          <button id="sendMessageBtn" class="button-primary bg-green-600 mt-4">Send Message</button>
        </div>

        <div>
          <h2 class="text-lg font-semibold mb-2">Sender Monitor Log</h2>
          <div id="monitorLogSender" class="log-area bg-black text-white p-4 h-64 overflow-y-scroll text-sm rounded-lg shadow-inner">Monitoring log...</div>
        </div>

        <div>
          <h2 class="text-lg font-semibold mb-2">Twilio SMS Log</h2>
          <div id="twilioSmsLog" class="log-area bg-purple-900 text-white p-4 h-64 overflow-y-scroll text-sm rounded-lg shadow-inner">Twilio log...</div>
        </div>
      `;
    }

    async function refreshContacts() {
      if (!uid()) return;
      const ref = collection(db, `contacts/${uid()}/contacts`);
      const snap = await getDocs(ref);
      state.contacts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      updateContactUI();
    }

    function updateContactUI() {
      const ul = el("contactsList");
      const select = el("recipientContact");
      ul.innerHTML = "";
      select.innerHTML = `<option value="">Select a Contact</option>`;
      state.contacts.forEach((c, i) => {
        ul.innerHTML += `<li>${c.name} (${c.method}): ${c.email || ''} ${c.phone || ''}</li>`;
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = c.name;
        select.appendChild(opt);
      });
    }

    function sendTwilioSms(to, body, messageId) {
      log(`📨 Sending SMS to ${to}`, 'twilioSmsLog');
      fetch('http://127.0.0.1:5000/send-sms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to, body, messageId })
      })
        .then(res => res.json())
        .then(result => {
          if (result.status === 'success') {
            log(`✅ SMS sent. SID: ${result.sid}`, 'twilioSmsLog');
          } else {
            throw new Error(result.error);
          }
        })
        .catch(err => log(`❌ SMS failed: ${err.message}`, 'twilioSmsLog'));
    }

    function setupHandlers() {
      el("addContactBtn").onclick = async () => {
        const name = el("contactName").value.trim();
        const email = el("contactEmail").value.trim();
        const phone = el("contactPhone").value.trim();
        const method = email ? 'app' : 'sms';
        if (!name || (!email && !phone)) return alert('Missing contact info');
        const ref = doc(collection(db, `contacts/${uid()}/contacts`));
        await setDoc(ref, { name, email, phone, method });
        await setDoc(doc(db, `publicInvites/${ref.id}`), { senderId: uid(), inviteStatus: "pending", name, email });
        log(`✅ Contact ${name} added + invite sent`);
        refreshContacts();
      };

      el("sendMessageBtn").onclick = async () => {
        const index = el("recipientContact").value;
        const contact = state.contacts[index];
        const content = el("messageContent").value;
        const rendezvousId = el("testRendezvousIdSender").value;
        const mode = document.querySelector('input[name="deliverySim"]:checked').value;
        const messageId = `m-${Date.now()}`;
        if (!contact || !content || !rendezvousId) return alert("Missing fields");

        log(`📤 Sending to ${contact.name} via ${contact.method}`);

        if (contact.method === 'app' && mode === 'failure' && contact.phone) {
          log(`⚠️ In-app failed. Fallback to SMS in 10s...`, 'warning');
          setTimeout(() => sendTwilioSms(contact.phone, content, messageId), 10000);
        } else if (contact.method === 'app' && mode === 'success') {
          await addDoc(collection(db, `artifacts/${uid()}/messages/${rendezvousId}/messages`), {
            content,
            senderId: uid(),
            contactId: contact.id,
            delivered: false,
            createdAt: new Date().toISOString()
          });
          log(`✅ Message stored in Firestore`);
        } else if (contact.method === 'sms') {
          sendTwilioSms(contact.phone, content, messageId);
        }
      };
    }

    onAuthStateChanged(auth, user => {
      el("currentUserDisplaySender").textContent = user?.email || "Not authenticated";
      el("currentUidDisplaySender").textContent = user?.uid || "N/A";
      if (user) refreshContacts();
    });

    el("signUpBtnSender")?.addEventListener("click", async () => {
      const email = el("authEmailSender").value;
      const pw = el("authPasswordSender").value;
      await createUserWithEmailAndPassword(auth, email, pw);
    });

    el("signInBtnSender")?.addEventListener("click", async () => {
      const email = el("authEmailSender").value;
      const pw = el("authPasswordSender").value;
      await signInWithEmailAndPassword(auth, email, pw);
    });

    el("signOutBtnSender")?.addEventListener("click", () => {
      signOut(auth);
    });

    buildUI();
    setupHandlers();
  </script>
</body>
</html>
