<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MeetSafe Reschedule Console (v27.7.25.2)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-100 text-gray-800 font-sans space-y-6">
  <h1 class="text-2xl font-bold">Reschedule Console <span class="text-sm text-gray-500">(v27.7.25.2)</span></h1>
  <div id="currentTime" class="text-sm text-gray-600"></div>

  <div>
    <input id="email" placeholder="Email" class="border px-2 py-1" />
    <input id="password" type="password" placeholder="Password" class="border px-2 py-1" />
    <button id="signInBtn" class="bg-blue-500 text-white px-3 py-1 rounded">Sign In</button>
    <button id="signOutBtn" class="bg-red-500 text-white px-3 py-1 rounded">Sign Out</button>
    <p>Signed in as: <span id="currentUserEmail">None</span></p>
  </div>

  <div>
    <h2 class="font-semibold text-lg mb-2">Your Rendezvous</h2>
    <div id="rendezvousList" class="space-y-4"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAV52Ads-ckhKuGsKvHoYYTrDIqBHMHusQ",
      authDomain: "meetsafe-clean-core.firebaseapp.com",
      projectId: "meetsafe-clean-core"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    function updateCurrentTime() {
      const now = new Date().toLocaleString("en-AU", { timeZone: "Australia/Brisbane" });
      document.getElementById("currentTime").textContent = `Current time (AEST): ${now}`;
    }

    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    document.getElementById("signInBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const pw = document.getElementById("password").value;
      await signInWithEmailAndPassword(auth, email, pw);
    };

    document.getElementById("signOutBtn").onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      document.getElementById("currentUserEmail").textContent = user ? user.email : "None";
      if (user) {
        loadRendezvous();
      } else {
        document.getElementById("rendezvousList").innerHTML = "";
      }
    });

    async function loadRendezvous() {
      const q = query(collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`), where("status", "==", "active"));
      const snap = await getDocs(q);
      const list = document.getElementById("rendezvousList");
      list.innerHTML = "";

      snap.forEach(docSnap => {
        const data = docSnap.data();
        const wrapper = document.createElement("div");
        wrapper.className = "bg-white p-4 rounded shadow";

        const header = document.createElement("h3");
        header.className = "font-semibold";
        header.textContent = data.contactName || "Unnamed Rendezvous";
        wrapper.appendChild(header);

        const startInput = document.createElement("input");
        startInput.type = "datetime-local";
        startInput.value = toInputDateTime(data.startTime?.seconds * 1000);
        startInput.className = "border p-1 m-1";

        const endInput = document.createElement("input");
        endInput.type = "datetime-local";
        endInput.value = toInputDateTime(data.endTime?.seconds * 1000);
        endInput.className = "border p-1 m-1";

        const checkInType = document.createElement("select");
        checkInType.className = "border p-1 m-1";
        ["none", "10min"].forEach(opt => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt === "10min" ? "10-Minute" : "None";
          if (data.checkInType === opt) o.selected = true;
          checkInType.appendChild(o);
        });

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "Save";
        saveBtn.className = "bg-green-600 text-white px-2 py-1 rounded ml-2";
        saveBtn.onclick = async () => {
          const ref = doc(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous/${docSnap.id}`);
          await updateDoc(ref, {
            startTime: Timestamp.fromDate(new Date(startInput.value)),
            endTime: Timestamp.fromDate(new Date(endInput.value)),
            checkInType: checkInType.value,
            updatedAt: Timestamp.now()
          });
          alert("Saved changes.");
        };

        wrapper.appendChild(startInput);
        wrapper.appendChild(endInput);
        wrapper.appendChild(checkInType);
        wrapper.appendChild(saveBtn);

        list.appendChild(wrapper);
      });
    }

    function toInputDateTime(ms) {
      const date = new Date(ms);
      const offset = date.getTimezoneOffset() * 60000;
      const localISO = new Date(ms - offset).toISOString().slice(0, 16);
      return localISO;
    }
  </script>
</body>
</html>
