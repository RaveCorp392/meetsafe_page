<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MeetSafe Reschedule Console v24.7.25.3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .cancelled {
      text-decoration: line-through;
      opacity: 0.5;
    }
  </style>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">MeetSafe Reschedule Console</h1>
    <span class="text-sm text-gray-500">v24.7.25.3</span>
  </div>

  <div class="mb-4">
    <input id="authEmail" placeholder="Email" class="border p-2 rounded mr-2">
    <input id="authPassword" type="password" placeholder="Password" class="border p-2 rounded mr-2">
    <button id="signInBtn" class="bg-blue-500 text-white px-3 py-1 rounded">Sign In</button>
    <button id="signOutBtn" class="bg-red-500 text-white px-3 py-1 rounded">Sign Out</button>
  </div>

  <div class="mb-6">
    Logged in as: <span id="currentUserDisplay">None</span>
  </div>

  <div id="rdvList" class="space-y-4"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, doc, updateDoc, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const config = {
      apiKey: "AIzaSyAV52Ads-ckhKuGsKvHoYYTrDIqBHMHusQ",
      authDomain: "meetsafe-clean-core.firebaseapp.com",
      projectId: "meetsafe-clean-core"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    document.getElementById("signInBtn").onclick = async () => {
      const email = document.getElementById("authEmail").value;
      const pw = document.getElementById("authPassword").value;
      await signInWithEmailAndPassword(auth, email, pw);
    };

    document.getElementById("signOutBtn").onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      currentUser = user;
      document.getElementById("currentUserDisplay").textContent = user?.email || "None";
      if (user) loadRendezvous();
    });

    function localInputString(timestamp) {
      const d = timestamp.toDate();
      const offset = d.getTimezoneOffset();
      const local = new Date(d.getTime() - offset * 60000);
      return local.toISOString().slice(0,16);
    }

    function timestampFromInput(str) {
      const d = new Date(str);
      return Timestamp.fromDate(d);
    }

    function createRdvCard(docSnap) {
      const data = docSnap.data();
      const card = document.createElement("div");
      card.className = `bg-white rounded shadow p-4 ${data.status === "cancelled" ? "cancelled" : ""}`;
      card.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-lg font-semibold">${data.contactName}</h2>
          <div>
            ${data.status !== "cancelled"
              ? `<button class="text-sm text-red-600 underline mr-2" data-action="cancel">Cancel</button>`
              : `<button class="text-sm text-green-600 underline" data-action="undo">Undo Cancel</button>`}
          </div>
        </div>
        <div class="space-y-2 ${data.status === "cancelled" ? "hidden" : ""}" data-editable>
          <input class="border p-2 w-full rounded" data-field="contactName" value="${data.contactName}">
          <input type="datetime-local" class="border p-2 w-full rounded" data-field="startTime" value="${localInputString(data.startTime)}">
          <input type="datetime-local" class="border p-2 w-full rounded" data-field="endTime" value="${localInputString(data.endTime)}">
          <select class="border p-2 w-full rounded" data-field="checkInType">
            <option value="none" ${data.checkInType === "none" ? "selected" : ""}>No Check-In</option>
            <option value="10min" ${data.checkInType === "10min" ? "selected" : ""}>10 Minute</option>
          </select>
          <button class="bg-blue-500 text-white px-4 py-2 rounded" data-action="save">Save</button>
        </div>
      `;

      const editable = card.querySelector("[data-editable]");
      const contactNameInput = card.querySelector('[data-field="contactName"]');
      const startInput = card.querySelector('[data-field="startTime"]');
      const endInput = card.querySelector('[data-field="endTime"]');
      const checkInSelect = card.querySelector('[data-field="checkInType"]');

      card.querySelectorAll("[data-action]").forEach(btn => {
        btn.onclick = async () => {
          const action = btn.getAttribute("data-action");
          const ref = doc(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous/${docSnap.id}`);
          if (action === "cancel") {
            await updateDoc(ref, { status: "cancelled" });
          } else if (action === "undo") {
            await updateDoc(ref, { status: "active" });
          } else if (action === "save") {
            await updateDoc(ref, {
              contactName: contactNameInput.value,
              startTime: timestampFromInput(startInput.value),
              endTime: timestampFromInput(endInput.value),
              checkInType: checkInSelect.value
            });
          }
        };
      });

      return card;
    }

    function loadRendezvous() {
      const list = document.getElementById("rdvList");
      const q = query(collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`));
      onSnapshot(q, snap => {
        list.innerHTML = "";
        snap.docs.forEach(doc => list.appendChild(createRdvCard(doc)));
      });
    }
  </script>
</body>
</html>
