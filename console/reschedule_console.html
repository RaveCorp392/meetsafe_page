<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MeetSafe Reschedule Console (v24.7.25.1)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    .log-area::-webkit-scrollbar { width: 8px; }
    .log-area::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
  </style>
</head>
<body class="p-6 space-y-6">
  <h1 class="text-3xl font-bold">MeetSafe Reschedule Console <span class="text-sm text-gray-500">(v24.7.25.1)</span></h1>

  <div id="rendezvousList" class="space-y-4"></div>

  <div id="log" class="bg-black text-white p-2 rounded log-area h-48 overflow-y-scroll text-sm">[log]</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, updateDoc, getDocs, query, collection, Timestamp, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const config = {
      apiKey: "AIzaSyAV52Ads-ckhKuGsKvHoYYTrDIqBHMHusQ",
      authDomain: "meetsafe-clean-core.firebaseapp.com",
      projectId: "meetsafe-clean-core"
    };

    const app = initializeApp(config);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const log = (msg) => {
      const el = document.createElement("div");
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById("log").appendChild(el);
    };

    const formatDateTimeLocal = (timestamp, tzOffsetMins) => {
      const localMillis = timestamp.seconds * 1000 + tzOffsetMins * 60000;
      return new Date(localMillis).toISOString().slice(0, 16); // for datetime-local
    };

    const renderList = async (uid) => {
      const q = query(collection(db, `artifacts/meetsafe-clean-core/users/${uid}/rendezvous`), where("status", "==", "active"));
      const snapshot = await getDocs(q);
      const area = document.getElementById("rendezvousList");
      area.innerHTML = "";

      snapshot.docs.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "bg-white p-4 shadow rounded space-y-2";

        const nameInput = document.createElement("input");
        nameInput.className = "w-full border p-1 rounded";
        nameInput.value = data.contactName || "";

        const startInput = document.createElement("input");
        startInput.type = "datetime-local";
        startInput.className = "w-full border p-1 rounded";
        const offset = data.timeZoneOffsetMins ?? -(new Date().getTimezoneOffset());
        startInput.value = formatDateTimeLocal(data.startTime, offset);

        const typeSelect = document.createElement("select");
        typeSelect.className = "w-full border p-1 rounded";
        ["none", "10min"].forEach(opt => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt;
          if (data.checkInType === opt) o.selected = true;
          typeSelect.appendChild(o);
        });

        const saveBtn = document.createElement("button");
        saveBtn.className = "bg-blue-600 text-white px-3 py-1 rounded";
        saveBtn.textContent = "Save";
        saveBtn.onclick = async () => {
          const ref = doc(db, `artifacts/meetsafe-clean-core/users/${uid}/rendezvous/${docSnap.id}`);
          await updateDoc(ref, {
            contactName: nameInput.value,
            checkInType: typeSelect.value,
            startTime: Timestamp.fromDate(new Date(startInput.value)),
            updatedAt: Timestamp.now()
          });
          log(`Updated ${nameInput.value}`);
        };

        div.appendChild(nameInput);
        div.appendChild(startInput);
        div.appendChild(typeSelect);
        div.appendChild(saveBtn);
        area.appendChild(div);
      });
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        log(`Signed in as ${user.email}`);
        renderList(user.uid);
      } else {
        const email = prompt("Email:");
        const password = prompt("Password:");
        signInWithEmailAndPassword(auth, email, password).catch(err => log("Login failed: " + err.message));
      }
    });
  </script>
</body>
</html>
