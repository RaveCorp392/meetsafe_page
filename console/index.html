<!-- MeetSafe Console (Start, Midpoint, End Check-ins) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MeetSafe Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f3f4f6;
      font-family: 'Inter', sans-serif;
    }
    .log-area { overflow-y: scroll; height: 150px; background: #111; color: white; padding: 10px; font-size: 0.9rem; }
  </style>
</head>
<body class="p-6 space-y-6">
  <h1 class="text-3xl font-bold">MeetSafe Console</h1>

  <div>
    <h2 class="text-xl font-semibold">Create Rendezvous</h2>
    <input id="contactName" placeholder="Contact Name" class="p-2 border rounded w-full my-2" />
    <input id="startTime" type="datetime-local" class="p-2 border rounded w-full my-2" />
    <input id="endTime" type="datetime-local" class="p-2 border rounded w-full my-2" />
    <button id="submitBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Submit</button>
  </div>

  <div id="checkinPrompt" class="hidden border p-4 rounded bg-yellow-100">
    <p id="checkinTitle" class="font-semibold mb-2">Check-in prompt:</p>
    <button onclick="handleCheckin('ok')" class="bg-green-500 text-white px-3 py-1 rounded">OK</button>
    <button onclick="handleCheckin('not_ok')" class="bg-red-500 text-white px-3 py-1 rounded">Not OK</button>
  </div>

  <div>
    <h2 class="text-lg font-semibold">Realtime Monitor</h2>
    <div id="monitorLog" class="log-area"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, Timestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyAV52Ads-ckhKuGsKvHoYYTrDIqBHMHusQ",
      authDomain: "meetsafe-clean-core.firebaseapp.com",
      projectId: "meetsafe-clean-core"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let prompted = new Set();

    const log = (msg) => {
      const logArea = document.getElementById("monitorLog");
      logArea.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      logArea.scrollTop = logArea.scrollHeight;
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        log(`Authenticated as ${user.uid}`);
      }
    });

    signInAnonymously(auth).catch((err) => log("Auth error: " + err.message));

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const name = document.getElementById("contactName").value;
      const start = new Date(document.getElementById("startTime").value);
      const end = new Date(document.getElementById("endTime").value);
      if (!currentUser) return alert("Not signed in");

      await addDoc(collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`), {
        contactName: name,
        startTime: Timestamp.fromDate(start),
        endTime: Timestamp.fromDate(end),
        createdAt: Timestamp.now(),
        status: "active",
        userId: currentUser.uid,
        startCheckinDone: false,
        midpointCheckinDone: false,
        endCheckinDone: false
      });
      log(`Rendezvous "${name}" created.`);
    });

    const handleCheckin = async (response) => {
      if (!window.promptDocId || !window.promptType) return;
      const ref = doc(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous/${window.promptDocId}`);
      const updateField = `${window.promptType}CheckinDone`;
      const responseField = `${window.promptType}CheckinResponse`;
      await updateDoc(ref, {
        [updateField]: true,
        [responseField]: response
      });
      log(`âœ”ï¸ ${window.promptType} check-in: ${response}`);
      document.getElementById("checkinPrompt").classList.add("hidden");
    };

    setInterval(async () => {
      if (!currentUser) return;
      const snapshot = await getDocs(query(collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`), where("status", "==", "active")));
      const now = Date.now();

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const id = docSnap.id;

        if (prompted.has(`${id}_start`) || data.startCheckinDone) return;

        const start = data.startTime?.toDate()?.getTime();
        if (start && Math.abs(now - start) < 30000) {
          window.promptDocId = id;
          window.promptType = "start";
          prompted.add(`${id}_start`);
          document.getElementById("checkinTitle").textContent = "Start Check-in: Are you OK?";
          document.getElementById("checkinPrompt").classList.remove("hidden");
          log("ðŸŸ¡ Prompting START check-in");
        }

        const midpoint = start + 60000;
        if (!prompted.has(`${id}_mid`) && !data.midpointCheckinDone && now >= midpoint && now - midpoint < 30000) {
          window.promptDocId = id;
          window.promptType = "midpoint";
          prompted.add(`${id}_mid`);
          document.getElementById("checkinTitle").textContent = "Midpoint Check-in: Are you OK?";
          document.getElementById("checkinPrompt").classList.remove("hidden");
          log("ðŸŸ  Prompting MIDPOINT check-in");
        }

        const end = data.endTime?.toDate()?.getTime();
        if (!prompted.has(`${id}_end`) && !data.endCheckinDone && now >= end && now - end < 30000) {
          window.promptDocId = id;
          window.promptType = "end";
          prompted.add(`${id}_end`);
          document.getElementById("checkinTitle").textContent = "End Check-in: Are you OK?";
          document.getElementById("checkinPrompt").classList.remove("hidden");
          log("ðŸ”´ Prompting END check-in");
        }
      });
    }, 5000);
  </script>
</body>
</html>
