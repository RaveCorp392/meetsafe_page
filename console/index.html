<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MeetSafe Console (Midpoint Test)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 space-y-6 text-gray-900">
  <h1 class="text-2xl font-bold">MeetSafe Console</h1>

  <div class="space-y-4 bg-white p-4 rounded shadow">
    <div>
      <input id="authEmail" placeholder="Email" class="p-2 border rounded w-64" />
      <input id="authPassword" placeholder="Password" type="password" class="p-2 border rounded w-64" />
      <button id="signUpBtn" class="bg-blue-500 text-white px-3 py-1 rounded">Sign Up</button>
      <button id="signInBtn" class="bg-green-600 text-white px-3 py-1 rounded">Sign In</button>
    </div>
    <div>Current: <span id="currentUser">None</span></div>
  </div>

  <div class="space-y-4 bg-white p-4 rounded shadow">
    <h2 class="text-lg font-semibold">Create Rendezvous</h2>
    <input id="contactName" placeholder="Contact name" class="p-2 border rounded w-64" />
    <input id="startTime" type="datetime-local" class="p-2 border rounded" />
    <input id="endTime" type="datetime-local" class="p-2 border rounded" />
    <button id="submitRdv" class="bg-purple-600 text-white px-4 py-1 rounded">Submit</button>
  </div>

  <div id="monitorLog" class="bg-black text-green-400 text-sm p-3 h-40 overflow-y-scroll font-mono rounded"></div>

  <div id="checkinPrompt" class="hidden bg-yellow-100 border p-4 rounded space-y-2">
    <p class="font-semibold" id="checkinTitle">Check-in</p>
    <button onclick="submitResponse('ok')" class="bg-green-500 text-white px-3 py-1 rounded">I'm OK</button>
    <button onclick="submitResponse('not_ok')" class="bg-red-500 text-white px-3 py-1 rounded">Not OK</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const config = {
      apiKey: "AIzaSyAV52Ads-ckhKuGsKvHoYYTrDIqBHMHusQ",
      authDomain: "meetsafe-clean-core.firebaseapp.com",
      projectId: "meetsafe-clean-core"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let user = null;

    const log = (msg) => {
      const div = document.createElement("div");
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById("monitorLog").appendChild(div);
    };

    document.getElementById("signUpBtn").onclick = async () => {
      const email = authEmail.value, pass = authPassword.value;
      await createUserWithEmailAndPassword(auth, email, pass);
    };

    document.getElementById("signInBtn").onclick = async () => {
      const email = authEmail.value, pass = authPassword.value;
      await signInWithEmailAndPassword(auth, email, pass);
    };

    onAuthStateChanged(auth, (u) => {
      user = u;
      document.getElementById("currentUser").textContent = u ? u.email : "None";
      if (u) monitorCheckins();
    });

    document.getElementById("submitRdv").onclick = async () => {
      const contact = contactName.value;
      const start = new Date(startTime.value);
      const end = new Date(endTime.value);
      await addDoc(collection(db, `artifacts/meetsafe-clean-core/users/${user.uid}/rendezvous`), {
        contactName: contact,
        startTime: Timestamp.fromDate(start),
        endTime: Timestamp.fromDate(end),
        createdAt: Timestamp.now(),
        userId: user.uid,
        initialCheckinDone: false,
        midpointCheckinDone: false,
        endCheckinDone: false,
        status: "active"
      });
      log(`Created rendezvous for ${contact}`);
    };

    let prompted = { start: false, mid: false, end: false };
    function monitorCheckins() {
      setInterval(async () => {
        const now = Date.now();
        const docs = await getDocs(query(
          collection(db, `artifacts/meetsafe-clean-core/users/${user.uid}/rendezvous`),
          where("status", "==", "active")
        ));

        docs.forEach(async (docSnap) => {
          const data = docSnap.data();
          const id = docSnap.id;
          const start = data.startTime?.toDate()?.getTime();
          const end = data.endTime?.toDate()?.getTime();

          if (!data.initialCheckinDone && now >= start && !prompted.start) {
            prompted.start = true;
            document.getElementById("checkinTitle").textContent = "Start of Rendezvous – Confirm";
            document.getElementById("checkinPrompt").classList.remove("hidden");
            window.activeDoc = docSnap.ref;
            window.activeType = "start";
          }

          if (data.initialCheckinDone && !data.midpointCheckinDone && now >= (start + 60000) && !prompted.mid) {
            prompted.mid = true;
            document.getElementById("checkinTitle").textContent = "Midpoint Check-In – Are You OK?";
            document.getElementById("checkinPrompt").classList.remove("hidden");
            window.activeDoc = docSnap.ref;
            window.activeType = "midpoint";
          }

          if (!data.endCheckinDone && now >= end && !prompted.end) {
            prompted.end = true;
            document.getElementById("checkinTitle").textContent = "End Check-In – Are You OK?";
            document.getElementById("checkinPrompt").classList.remove("hidden");
            window.activeDoc = docSnap.ref;
            window.activeType = "end";
          }
        });
      }, 2000);
    }

    window.submitResponse = async (response) => {
      const ref = window.activeDoc;
      const type = window.activeType;
      const field = type === "start" ? "initialCheckinDone" : type === "midpoint" ? "midpointCheckinDone" : "endCheckinDone";

      await updateDoc(ref, {
        [field]: true
      });

      const logsRef = collection(ref, "checkin_log");
      await addDoc(logsRef, {
        type,
        response,
        timestamp: Timestamp.now()
      });

      document.getElementById("checkinPrompt").classList.add("hidden");
      log(`${type} check-in logged as: ${response}`);
    };
  </script>
</body>
</html>
