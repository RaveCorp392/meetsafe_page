<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MeetSafe Web Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-black p-6 space-y-6">
  <h1 class="text-2xl font-bold">MeetSafe Web Console</h1>

  <!-- Auth Panel -->
  <div class="space-x-2">
    <input id="email" placeholder="Email" class="border p-1" />
    <input id="password" type="password" placeholder="Password" class="border p-1" />
    <button id="signUpBtn" class="bg-blue-500 text-white px-2">Sign Up</button>
    <button id="signInBtn" class="bg-green-500 text-white px-2">Sign In</button>
    <button id="signOutBtn" class="bg-red-500 text-white px-2">Sign Out</button>
    <p>Current User: <span id="userEmail">None</span></p>
    <p>User ID: <span id="userId">None</span></p>
  </div>

  <!-- Rendezvous Form -->
  <div class="bg-white p-4 rounded shadow w-full max-w-lg">
    <h2 class="font-semibold mb-2">Create Rendezvous</h2>
    <input id="contactName" placeholder="Name" class="w-full border mb-2 p-1" />
    <select id="checkinType" class="w-full border mb-2 p-1">
      <option value="none">No Check-In</option>
      <option value="10min">10-Minute Check-In</option>
      <option value="midpoint">Midpoint Check-In</option>
    </select>
    <input id="startTime" type="datetime-local" class="w-full border mb-2 p-1" />
    <input id="endTime" type="datetime-local" class="w-full border mb-2 p-1" />
    <button id="submitBtn" class="bg-green-600 text-white w-full py-1 rounded">Submit</button>
  </div>

  <!-- Check-In Prompt -->
  <div id="promptBox" class="hidden p-3 bg-yellow-200 rounded">
    <p id="promptText" class="font-medium">Prompt text here</p>
    <div class="space-x-2 mt-2">
      <button onclick="handleCheckin('start')" class="bg-blue-600 text-white px-2">Start On Time</button>
      <button onclick="handleCheckin('late')" class="bg-yellow-600 text-white px-2">Running Late</button>
      <button onclick="handleCheckin('midpoint_ok')" class="bg-green-600 text-white px-2">Mid OK</button>
      <button onclick="handleCheckin('midpoint_not_ok')" class="bg-red-600 text-white px-2">Mid Not OK</button>
      <button onclick="handleCheckin('end_ok')" class="bg-green-800 text-white px-2">End OK</button>
      <button onclick="handleCheckin('end_not_ok')" class="bg-red-800 text-white px-2">End Not OK</button>
    </div>
  </div>

  <p><strong>Current Time:</strong> <span id="clock"></span></p>
  <h3 class="font-semibold">Monitor:</h3>
  <div id="logBox" class="bg-black text-white p-2 h-48 overflow-y-scroll text-sm font-mono">Monitoring log...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, addDoc, updateDoc, doc, getDocs, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const config = {
      apiKey: "AIzaSyAV52Ads-ckhKuGsKvHoYYTrDIqBHMHusQ",
      authDomain: "meetsafe-clean-core.firebaseapp.com",
      projectId: "meetsafe-clean-core"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let promptedDocId = null;
    const promptedDocs = new Set();

    function log(msg) {
      const el = document.createElement("div");
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById("logBox").appendChild(el);
    }

    function showPrompt(type) {
      const box = document.getElementById("promptBox");
      const text = document.getElementById("promptText");
      box.classList.remove("hidden");
      if (type === "start") text.textContent = "Start Check-In";
      else if (type === "midpoint") text.textContent = "Midpoint Check-In";
      else if (type === "end") text.textContent = "End Check-In";
    }

    window.handleCheckin = async (type) => {
      if (!currentUser || !promptedDocId) return;
      const ref = doc(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous/${promptedDocId}`);
      const updates = {};
      if (type === "start" || type === "late") {
        updates.initialCheckinDone = true;
        updates.initialCheckinResponse = type;
      }
      if (type === "midpoint_ok" || type === "midpoint_not_ok") {
        updates.midpointCheckinDone = true;
        updates.midpointCheckinResponse = type;
      }
      if (type === "end_ok" || type === "end_not_ok") {
        updates.endCheckinDone = true;
        updates.endCheckinResponse = type;
      }
      await updateDoc(ref, updates);
      document.getElementById("promptBox").classList.add("hidden");
      log(`Logged check-in response: ${type}`);
    };

    async function checkActive() {
      if (!currentUser) return;
      const q = query(collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`), where("status", "==", "active"));
      const snap = await getDocs(q);
      const now = Math.floor(Date.now() / 1000);

      snap.docs.forEach(docSnap => {
        const data = docSnap.data();
        const start = data.startTime?.seconds;
        const end = data.endTime?.seconds;
        const midpoint = start + 60;

        if (!promptedDocs.has(docSnap.id)) {
          if (start && now >= start && now - start < 60 && !data.initialCheckinDone) {
            promptedDocId = docSnap.id;
            promptedDocs.add(docSnap.id);
            showPrompt("start");
            log(`Start time reached for ${data.contactName}. Prompting...`);
          } else if (data.initialCheckinDone && !data.midpointCheckinDone && now >= midpoint && now - midpoint < 60) {
            promptedDocId = docSnap.id;
            promptedDocs.add(docSnap.id);
            showPrompt("midpoint");
            log(`Midpoint check-in due for ${data.contactName}. Prompting...`);
          } else if (data.midpointCheckinDone && !data.endCheckinDone && now >= end && now - end < 60) {
            promptedDocId = docSnap.id;
            promptedDocs.add(docSnap.id);
            showPrompt("end");
            log(`End time reached for ${data.contactName}. Prompting end check-in...`);
          }
        }
      });
    }

    setInterval(checkActive, 1000);

    document.getElementById("submitBtn").onclick = async () => {
      const name = document.getElementById("contactName").value;
      const checkinType = document.getElementById("checkinType").value;
      const start = new Date(document.getElementById("startTime").value);
      const end = new Date(document.getElementById("endTime").value);

      const docRef = await addDoc(collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`), {
        contactName: name,
        checkInType: checkinType,
        userId: currentUser.uid,
        startTime: Timestamp.fromDate(start),
        endTime: Timestamp.fromDate(end),
        status: "active",
        createdAt: Timestamp.now(),
        initialCheckinDone: false,
        midpointCheckinDone: false,
        endCheckinDone: false
      });
      log(`Created rendezvous: ${name}`);
    };

    document.getElementById("signInBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const pw = document.getElementById("password").value;
      await signInWithEmailAndPassword(auth, email, pw);
    };

    document.getElementById("signUpBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const pw = document.getElementById("password").value;
      await createUserWithEmailAndPassword(auth, email, pw);
    };

    document.getElementById("signOutBtn").onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      document.getElementById("userEmail").textContent = user?.email || "None";
      document.getElementById("userId").textContent = user?.uid || "None";
    });

    setInterval(() => {
      document.getElementById("clock").textContent = new Date().toLocaleTimeString();
    }, 1000);
  </script>
</body>
</html>
