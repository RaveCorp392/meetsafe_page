<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meetsafe Web Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-100 space-y-10 font-sans">
  <h1 class="text-3xl font-bold">MeetSafe Web Console</h1>

  <div class="space-y-2">
    <h2 class="text-xl font-semibold">Authentication</h2>
    <input type="email" id="authEmail" placeholder="Email" class="p-2 border rounded w-full max-w-md" />
    <input type="password" id="authPassword" placeholder="Password" class="p-2 border rounded w-full max-w-md" />
    <div class="space-x-2">
      <button id="signUpBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Sign Up</button>
      <button id="signInBtn" class="bg-green-600 text-white px-3 py-1 rounded">Sign In</button>
      <button id="signOutBtn" class="bg-red-600 text-white px-3 py-1 rounded">Sign Out</button>
    </div>
    <p>Current User: <span id="currentUserDisplay">Not authenticated</span><br />
       User ID: <span id="currentUidDisplay">N/A</span></p>
  </div>

  <div class="space-y-2 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold">Create Rendezvous</h2>
    <input class="block mb-2 w-full p-2 border rounded" id="contactName" placeholder="Contact Name" />
    <input class="block mb-2 w-full p-2 border rounded" type="datetime-local" id="startTime" />
    <input class="block mb-2 w-full p-2 border rounded" type="datetime-local" id="endTime" />
    <button class="bg-green-500 text-white px-4 py-2 rounded" id="submitRdv">Submit</button>
  </div>

  <div class="space-y-2 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold">Current Time</h2>
    <p class="text-lg text-gray-800" id="clockDisplay"></p>
  </div>

  <div class="space-y-2 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold">Monitor</h2>
    <div id="monitorLog" class="bg-black text-white p-2 rounded h-40 overflow-y-scroll text-sm font-mono">Monitoring log...</div>
  </div>

  <div id="checkinPrompt" class="hidden bg-yellow-100 border border-yellow-300 text-yellow-900 rounded p-4">
    <p class="font-medium mb-2">Start check-in: What would you like to do?</p>
    <div class="space-x-2">
      <button class="bg-blue-500 text-white px-3 py-1 rounded" onclick="handleCheckin('start')">Start on Time</button>
      <button class="bg-yellow-500 text-white px-3 py-1 rounded" onclick="handleCheckin('late')">Running Late</button>
      <button class="bg-orange-500 text-white px-3 py-1 rounded" onclick="logToMonitor('User selected: Reschedule')">Reschedule</button>
      <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="logToMonitor('User selected: Cancel')">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, Timestamp, doc, updateDoc, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const config = {
      apiKey: "AIzaSyAV52Ads-ckhKuGsKvHoYYTrDIqBHMHusQ",
      authDomain: "meetsafe-clean-core.firebaseapp.com",
      projectId: "meetsafe-clean-core"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let promptedDocId = null;
    const promptedDocs = new Set();

    const clock = document.getElementById("clockDisplay");
    const brisbaneTimeString = (d = new Date()) => d.toLocaleTimeString('en-AU', { timeZone: 'Australia/Brisbane', hour12: false });
    setInterval(() => clock.textContent = brisbaneTimeString(), 1000);

    const logToMonitor = (msg) => {
      const area = document.getElementById("monitorLog");
      const div = document.createElement("div");
      div.textContent = `[${brisbaneTimeString()}] ${msg}`;
      area.appendChild(div);
      area.scrollTop = area.scrollHeight;
    };

    window.handleCheckin = async (type) => {
      if (!currentUser || !promptedDocId) return;
      const ref = doc(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous/${promptedDocId}`);
      await updateDoc(ref, { initialCheckinDone: true, initialCheckinResponse: type });
      logToMonitor(`Logged check-in response: ${type}`);
      document.getElementById("checkinPrompt").classList.add("hidden");
    };

    const checkStartTimes = (docs) => {
      const now = Math.floor(Date.now() / 1000);
      docs.forEach(docSnap => {
        const data = docSnap.data();
        const start = data.startTime?.seconds;
        if (start && now >= start && now - start < 60 && !data.initialCheckinDone && !promptedDocs.has(docSnap.id)) {
          promptedDocId = docSnap.id;
          promptedDocs.add(promptedDocId);
          logToMonitor(`Start time reached for ${data.contactName}. Prompting...`);
          document.getElementById("checkinPrompt").classList.remove("hidden");
        }
      });
    };

    setInterval(async () => {
      if (!currentUser) return;
      const q = query(collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`), where("status", "==", "active"));
      const snap = await getDocs(q);
      checkStartTimes(snap.docs);
    }, 1000);

    document.getElementById("submitRdv").addEventListener("click", async () => {
      if (!currentUser) return alert("Not signed in.");
      const contactName = document.getElementById("contactName").value;
      const start = new Date(document.getElementById("startTime").value);
      const end = new Date(document.getElementById("endTime").value);
      await addDoc(collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`), {
        contactName,
        startTime: Timestamp.fromDate(start),
        endTime: Timestamp.fromDate(end),
        createdAt: Timestamp.now(),
        userId: currentUser.uid,
        initialCheckinDone: false,
        mode: "normal",
        checkInType: "none",
        status: "active"
      });
      logToMonitor(`Created rendezvous: ${contactName}`);
    });

    document.getElementById("signUpBtn").onclick = async () => {
      const email = document.getElementById("authEmail").value;
      const password = document.getElementById("authPassword").value;
      await createUserWithEmailAndPassword(auth, email, password).catch(e => logToMonitor("Signup error: " + e.message));
    };

    document.getElementById("signInBtn").onclick = async () => {
      const email = document.getElementById("authEmail").value;
      const password = document.getElementById("authPassword").value;
      await signInWithEmailAndPassword(auth, email, password).catch(e => logToMonitor("Signin error: " + e.message));
    };

    document.getElementById("signOutBtn").onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      currentUser = user;
      document.getElementById("currentUserDisplay").textContent = user ? user.email : "Not authenticated";
      document.getElementById("currentUidDisplay").textContent = user ? user.uid : "N/A";
      if (user) {
        const q = query(collection(db, `artifacts/meetsafe-clean-core/users/${user.uid}/rendezvous`), where("status", "==", "active"));
        onSnapshot(q, (snap) => {
          snap.docChanges().forEach(change => {
            const data = change.doc.data();
            logToMonitor(`${change.type.toUpperCase()} ${data.contactName}`);
          });
          checkStartTimes(snap.docs);
        });
      }
    });
  </script>
</body>
</html>
