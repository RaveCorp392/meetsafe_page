<!-- üî• Insert after start check-in logic -->
const checkMidpointTimes = (docs) => {
  const now = Math.floor(Date.now() / 1000);
  docs.forEach(docSnap => {
    const data = docSnap.data();
    const docId = docSnap.id;
    const start = data.startTime?.seconds;
    const checkType = data.checkInType;

    // Skip if not '10min' type or already done
    if (checkType !== "10min" || data.midpointCheckinDone) return;

    const midpoint = start + 60; // üîÅ 1 min after startTime (test logic)

    if (start && now >= midpoint && now - midpoint < 60 && !promptedDocs.has(`midpoint-${docId}`)) {
      promptedDocId = docId;
      promptedDocs.add(`midpoint-${docId}`);
      document.getElementById('checkinPrompt').classList.remove('hidden');
      logToMonitor(`Midpoint check-in due for ${data.contactName}. Prompting...`);
    }
  });
};

window.handleCheckin = async (type) => {
  if (!currentUser || !promptedDocId) return;
  const ref = doc(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous/${promptedDocId}`);
  const docSnap = await getDoc(ref);
  const data = docSnap.data();

  const updatePayload = {};
  if (!data.initialCheckinDone) {
    updatePayload.initialCheckinDone = true;
    updatePayload.initialCheckinResponse = type;
  } else if (data.checkInType === "10min" && !data.midpointCheckinDone) {
    updatePayload.midpointCheckinDone = true;
    updatePayload.midpointCheckinResponse = type;
  }

  await updateDoc(ref, updatePayload);
  logToMonitor(`Logged check-in response: ${type}`);
  document.getElementById('checkinPrompt').classList.add('hidden');
};

setInterval(async () => {
  if (!currentUser) return;
  const q = query(
    collection(db, `artifacts/meetsafe-clean-core/users/${currentUser.uid}/rendezvous`),
    where("status", "==", "active")
  );
  const snapshot = await getDocs(q);
  checkStartTimes(snapshot.docs);
  checkMidpointTimes(snapshot.docs); // ‚è± Add this line
}, 1000);
